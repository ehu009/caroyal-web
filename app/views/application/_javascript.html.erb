<script>
  function isElementInViewport(el) {
    var rect = el.getBoundingClientRect();
    return (
      rect.top >= 0 &&
      rect.left >= 0 &&
      rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
      rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
  }

  function callbackFunc() {
    var items = document.querySelectorAll(".timeline li");
    for (var i = 0; i < items.length; i++) {
      
      if (isElementInViewport(items[i])) {
        
        items[i].classList.add("in-view");
      }
    }
  }
  window.addEventListener("load", callbackFunc);
  window.addEventListener("scroll", callbackFunc);


  
  function open_nav(id) {
    var e = document.getElementById(id);
    e.classList.add('nav-veil-fadein');
    e.classList.remove('nav-veil-fadeout');
  }
  function close_nav(id) {
    var e = document.getElementById(id);
    e.classList.remove('nav-veil-fadein');
    e.classList.add('nav-veil-fadeout');
  }
  function burger_toggle(burger_id, closer_id, veil_id) {
    var b = document.getElementById(burger_id);
    var c = document.getElementById(closer_id);
    if (c.style.display == "none")
    {
      b.style.display = "none";
      c.style.display = "initial";
    } else {
      b.style.display = "initial";
      c.style.display = "none";
    }
  }

  function unveil(id) {
    var e = document.getElementById(id);
    e.classList.add('veil-fadeout');
  }
  function remove_toast(id) {
    var e = document.getElementById(id);
    e.classList.remove('show');
  }



    
  var cityData = null;
  var cityDataAvailable = new Event("city-data-available");

  var phoneData = null;
  var phoneDataAvailable = new Event("phone-data-available");

  var phoneFlags = null;
  var phoneFlagsAvailable = new Event("phone-flags-available");


  function cityDataSuccess(data) {
    cityData = JSON.parse(data);
    dispatchEvent(cityDataAvailable);
  }
  function phoneDataSuccess(data) {
    phoneData = JSON.parse(data);
    dispatchEvent(phoneDataAvailable);
  }
  function phoneFlagsSuccess(data) {
    phoneFlags = JSON.parse(data);
    dispatchEvent(phoneFlagsAvailable);
  }

  function getJSONData(data_url, success) {

    var getJSON = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onload = function() {
            var status = xhr.status;
            if (status === 200) {
              callback(null, xhr.response);
            } else {
              callback(status, xhr.response);
            }
          };
        xhr.send();
      };
    getJSON(data_url,
        function(err, data) {
          if (err !== null) {
            alert('Something went wrong while loading city data: ' + err);
          } else {
            success(data);
          }
        });
  }


  function addSelectOption(elem, option, text) {
    var opt = document.createElement("option");
    opt.value = option;
    opt.text = text;
    elem.appendChild(opt);
  }
  function initSelect(elem, text) {
    var opt = document.createElement("option");
    opt.disabled = true;
    opt.text = text;
    elem.appendChild(opt);
    elem.selectedIndex = 0;
  }
  function resetSelect(elem, text) {
    elem.innerHTML = '';
    initSelect(elem, text);
  }
  function initSelectorWith(elem, value, print) {
    for (let i = 0; i < elem.options.length; i += 1) {
      var e = elem.options.item(i);
      if (e.value == value) {
        elem.selectedIndex = i;
        break;
      }
    }
  }

  function populateCitySelect(elem, countryCode) {
    var filtered = cityData.filter(city => city['country'] == countryCode);
    var l = [];
    for (e of filtered) {
      l.push(e['name']);
    }
    for (e of l.sort()) {
      addSelectOption(elem, e, e);
    }
  }

  function initCitySelector(countrySelectId, citySelectId, initCountry, initCity, spinner) {
    document.getElementById(spinner).style.display = "block";
    var country_field = document.getElementById(countrySelectId);
    var city_field = document.getElementById(citySelectId);

    var text = "Select a country first";
    initSelect(city_field, text);
    
    addEventListener("city-data-available",() => {
        if (initCountry != "") {

          initSelectorWith(country_field, initCountry, false);
          if (initCity != "" | initCity != undefined) {
            populateCitySelect(city_field, initCountry);
            initSelectorWith(city_field, initCity, true);
          }
        }
        country_field.onchange = function () {
            document.getElementById(spinner).style.display = "block";
            resetSelect(city_field, text);
            populateCitySelect(city_field, country_field.value);
            document.getElementById(spinner).style.display = "none";
          };
        document.getElementById(spinner).style.display = "none";
      }, false);
  }

  function selectPhoneCode(elem, value, hiddenField, buttonElem) {
    var url = ""
    for (e of elem.childNodes) { 
      e.classList.remove("active")
      var c = e.firstChild.firstChild;

      if (c.childNodes[0].textContent == value) {
        url = c.childNodes[1].firstChild.style.backgroundImage.split('"')[1]
        break;
      }
    }
    var mm = document.getElementById("user_phone_code_dropdown-button").childNodes
    
    console.log(mm);
    mm[1].textContent = value;
    
  console.log(mm[0]);
  console.log(mm[1]);
console.log(mm[2]);

    var bb = mm[3];
    console.log(bb)
    bb.src = url;
    
    hiddenField.value = value;
  }



  function populatePhoneSelect(elem, hiddenField) {
    for (e of phoneData) {
        
      let dial = e['dial_code'];
      let country = phoneFlags[e['code']];

      let opt = document.createElement("li");
      let a = document.createElement("a");
      a.classList.add("dropdown-item");
      a.href = "#"

      let row = document.createElement("div");
      let c1 = document.createElement("div");
      let c2 = document.createElement("div");
      let c3 = document.createElement("div");
      row.classList.add("container-fluid", "row");
      c1.classList.add("col-3");
      c1.classList.add("dial-code");
      c1.appendChild(document.createTextNode(dial));
      row.appendChild(c1);
    
      c2.classList.add("col-1");
      if (country != undefined) {
        let sp = document.createElement("span");
        sp.classList.add("flag-dropdown");
        sp.style.backgroundImage = "url("+country['image']+")";
        c2.appendChild(sp);
      }
      row.appendChild(c2);

      c3.classList.add("col-7");
      let cname = document.createElement("span");
      cname.appendChild(document.createTextNode(e['name']));
      c3.appendChild(cname)
      row.appendChild(c3);

      a.appendChild(row);

      a.onclick = function () {
          selectPhoneCode(elem, dial, hiddenField)
        };
      opt.appendChild(a);
      elem.appendChild(opt);
        
    }
  }

  function initPhoneSelector(phoneCodeSelectId, initCountry, hiddenField, spinner) {
    document.getElementById(spinner).style.display = "block";
    var phone_code_field = document.getElementById(phoneCodeSelectId);
    var hidden_field = document.getElementById(hiddenField);
    document.getElementById("user_phone_code_dropdown-button").childNodes[1].textContent = "Dial code";
    addEventListener("phone-data-available", () => {
        addEventListener("phone-flags-available", () => {
            populatePhoneSelect(phone_code_field, hidden_field);
            if (initCountry != "") {
              selectPhoneCode(phone_code_field, initCountry, hidden_field, document.getElementById(phoneCodeSelectId+"-btn"));
            }
            document.getElementById(spinner).style.display = "none";
          }, false);
      }, false);
  }

</script>